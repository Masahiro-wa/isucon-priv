🌾以下の記事とリポジトリはそこまで関係ありません。リポジトリは書籍「達人が教えるWebパフォーマンスチューニング 〜ISUCONから学ぶ高速化の実践」のチューニングしていたものとなります。
ISUCON14の我々のリポジトリを公開して良いかわからないため、こちらに記述します。

## ISUCON14に参戦しました

2024/12/8(日)に開催されたISUCON14に初参加しました。記事を書くまでがISUCONということで、せっかくなので準備から結果発表までの流れを書きます。

### ISUCON とは？！
Iikanjini Speed Up Contestの略称であり、

```text
公式引用：
ISUCONとはLINEヤフー株式会社が運営窓口となって開催している、お題となるWebサービスを決められたレギュレーションの中で限界まで高速化を図るチューニングバトルです。
```
要するに当日Webアプリとその仕様が渡され、あとはいい感じに性能を上げていく大会です。

大会に関する詳細はこちらの[ISUCON公式](https://isucon.net/) をご覧ください。
また、リポジトリも公開されています。
https://github.com/isucon/isucon14

### 参加のキッカケ
たまたま大学の時の先輩（ykykiさん）とご飯に行く時があり、その際に興味がある技術の勉強会をしようとなりました。特にMySQLやサーバーチューニング系に二人とも興味があり、調べていくとISUCONなるものがあるので、とりあえず参加してみるかという軽いノリで参加しました。
- チーム名：tohokud 
- メンバー：ykyki, mwata 
- 言語：Go
で参戦しました。（最大は3人まで参加可能）

### 結果
- 順位：119/831
- スコア：11,27

初参加で上位15%に食い込めたとはいえ、序盤が順調であったのでかなり悔しかったです。

全チームの結果：
https://isucon.net/archives/58837992.html

我々の点数の推移（途中方針を変えてから伸びていますが、すぐ伸び悩んでいる。。。）：
![image](https://github.com/user-attachments/assets/9aa2238f-3b7f-4205-95a0-841d4095285d)

## 参加を決めてから当日まで
### 調査編（9月ごろから開始）
まずは過去のISUCONの参加記録をブログなどで調べて雰囲気や勉強の流れをつかみました。
特に優勝者の記事を見て、ISUCONの基本のキであったり、扱えるようになるべきAPMツールを学び、普段は触れない情報に感化されてやる気に火をつけていました。
実は初めは調査だけで参加の予定はなかったのですが、未知の世界に飛び込んでみたい好奇心が優って参加を決めました。

### 環境準備編
ISUCON本番では自分たちのAWS環境に配布されたCloudFormationをデプロイしてサーバーを構築します。
そのためAWS環境とSlackチャンネル、ドキュメンント置き場のscrapbox を作成して学んだことを共有していきました。
🌾ここでAWSエンジニアとしての経験が生き、
- AWS Identity Centerでのアクセス
- コストチェック→Slackに毎日詳細を通知　するLambdaの実装
- ISUCON練習用のカスタムイメージ作成（Packer）やAutoscalling設定による簡単なデプロイ
- CDKを用いたデプロイのさらなる簡略化
などなど快適かつ安全にAWS環境を使う準備を高速で整えました。

### 学習
こちらの書籍：
達人が教えるWebパフォーマンスチューニング 〜ISUCONから学ぶ高速化の実践
藤原 俊一郎 (著), 馬場 俊彰 (著), 中西 建登 (著), 長野 雅広 (著), 金子 達哉 (著), 草野 翔 (著)
https://amzn.asia/d/aXuS3of

を中心に、実際にベンチマーカーを動かしながらチューニング技法を学び、当日までにはMySQL/NGINX(リバースプロキシー)の観測のためのツールや設定をmake コマンド一発でできるようにツール化していました。
🌾今回我々が検証したツールは以下です
- pd-query-digester : スロークエリの解析のため、本番でもログをローテートしながらベンチマーカーを動かすたび解析に使用
- alp コマンド：NGINXのアクセスログから時間がかかっているパスを特定すために使用。しかし、本番では以下のDuckDBを使用。
- DuckDB：JSONログからSQLクエリベースで解析するのに使用。こちらは本番でも使用
- Ancible：直前に非常に有用であることに気がついたが、本番までに独自のツールとしてまとめきれなかった
- pprof：Goのパフォーマンスを可視化するために使用。こちらも本番ですぐ導入できたため採用。
- OpenTelemetry,ElasticAPM, ElasticSearch：
  業務の経験を活かして、APMツール検証で OpenTelemetry＋ElasticAPM＋ElasticSearch を検討していたのですが、NGINXへの導入が大変なこと、証明書の管理をしてHTTPSでデータを送れるようにするにはコストが高いことで断念してpprofに。
他にもいくつかありますが、メインで調査したのはこの辺り

（また、ここで学んだDBのチューニングは業務で還元され、大変問題になっていた当方のプロジェクトのシステムが非常に効率化できました。。。）

最終的にはMemcacheの導入やN＋1問題の解決により、書籍の練習ではGoでの実装で20万点を出すことができるようになり、セットアップツールの準備も含めて準備万端！と思っておりました。

## 大会当日
当日は開始1時間前の9:00にディスコードに集まり、流れや昨日のチューニング結果を話し合いながら開始を待っていました。
また、開発で使うためのGithubリポジトリもこの段階で作成しています。

### 役割
特に明確に分けておらず、都度発見したボトルネックを対応していましたが、ざっくり
- ykykiさん：レギュレーション読み込み、インスタンス初期セットアップ、超ボトルネックになっているSQL文と周辺ロジックの改良、
- mwata：アプリマニュアルの読み込み、サーバーの構成変更、データの観測と全体的なチューニング
という感じだったと思います。

タイムスタンプをとったいなかったため、以下は曖昧な状況報告となります。
### 10:00〜11:00
AWSへのデプロイ、ドキュメント読み込み、ベンチマーカの実行確認、Githubへのアプリ追加、初期セットアップ
を1時間ほどで行い、測定はすぐできるようになっていました。
特にサービスのGo実行ファイルを我々のブランチ配下に変えることにより、ローカルで開発しながら直ちにサーバーに反映できるCI/CDパイプラインを組み込むことが出来ました。

### 11:00〜12:00
3台あるインスタンスのうち、一つはMySQL専用にするため余計なサービスを停止し、他の２つもアプリサーバーとNGINXのみを稼働するように修正
この対応の時点で数千点は上がりましたが、htopで観測するとMySQlの負荷が常に100%で、Goアプリ側が30%ほどになっていたため明らかにMySQLのチューニングが先に必要そうであることがわかりました。
ツールを使ってスロークエリログを解析し、EXPLAINで効率を調べながらINDEXを作成していくと、これでも数千点が上がりました。
また、NGINXの設定でも静的コンテンツをサーバから配布するようにしましたが、今回は画像を頻繁にやり取りするサービスでないため、あんまり点は伸びなかったかも？

### 12:00〜15:00
INDEXの対応でもどうにもならないかなり複雑なクエリが、パフォーマンスの50%を占めていることが明らかになったため、ykykiさんがこちらを集中して対応。私はDuckDBでNGINXのログを読み込み、API側でかなりボトルネックになっている箇所を発見して対応しました。
お互いにここでかなりの時間を食ってしまい、伸び悩む原因に。。。

私は呼ばれる頻度が高く、SQLも多い関数のチューニングに取り組みましたが、
- 覚えてきたCacheの技法も常に最新のデータを取得する必要があるため断念
- SQL分のJOINでまとめる方法も、Transactionで処理されている部分のため、下手にまとめることが出来ない
ということが判明しただけで時間を食べ過ぎてしまいました。。。一方、同時にアプリ仕様書に目を向け、リトライ回数の部分がチューニングで来そうだったので、操作してみるとそこそこ点数が上がりました。

ykykiさんもロジックの変更に取り組んでいましたが、デプロイ後にベンチマーカーが動かない常態が続き諦めて簡易版の修正に。
後にwhere句の抜けに気がついて当初50%ほど不可になっていた問題が20%前後までに下がり、点数もアップ。

### 15:00〜17:00
大物SQLが半分ほど退いた影響で次第にアプリサーバーの負荷も60~70％に上がり、負荷バランスも全体的になりました。
一方MySQLがボトルネックになっているのは相変わらずであり、大物の影に隠れていたSQLのチューニングを実施していました。
その中で、Commit系の操作が負荷上位に入っていることが判明したので（先ほどチューニングに失敗していたapiの部分）
プリペアードステートメントの設定やBinar Log など、MySQL側の設定ファイルを操作することで少しは点数が上がりました。

しかし、やはりTransactionの処理と大物SQLがボトルネックになっていることは明らかで、ここを解消しないと大きく点が伸びないことに気がつき、再度チャレンジしました。
アプリ仕様書でこのAPIをSSE(Server-Sent Events)に変えることができることに気がつきましたが、時間がすでになく断念。。

### 17:00〜18:00
詳細なログを出す設定を最小限にするなど、観測用から実稼働用に設定を変えて、再起動試験などの最終走行に向けた調整をしていました。
後半は何度も再起動ー＞ベンチマークを繰り返し、点が上がることをお祈り！（なお、単調減少していました。。。）

### 反省
今回はアプリの速さを追求するより、いかに待ち状態の顧客を減らしていけるか、が大きな得点源になったそうで、改めてアプリ仕様書等を読み込む重要性を実感しました。
大事なのはアプリの速さより顧客体験！！
ここを前提とすればキャッシュの技術なども活かして高得点が狙えたのかなと考えています。

大会参加を通して身につけたスキルはすでに実業務でも生かされており、エンジニアとしてますます楽しく生活できております！
運営の皆様には感謝申し上げます！

この調子で今回使えなかったツールも磨いていき、来年は一回りレベルアップした状態で参加したいです！
